#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys
from pathlib import Path

from django.utils import autoreload


# get_child_arguments() is just a copy of django.utils.autoreload.get_child_arguments with required fixes
def get_child_arguments():
    """
    Return the executable. This contains a workaround for Windows if the
    executable is reported to not have the .exe extension which can cause bugs
    on reloading.
    """
    import __main__
    py_script = Path(sys.argv[0])

    args = [sys.executable] + ['-W%s' % o for o in sys.warnoptions]
    # __spec__ is set when the server was started with the `-m` option,
    # see https://docs.python.org/3/reference/import.html#main-spec
    # __spec__ may not exist, e.g. when running in a Conda env.
    if getattr(__main__, '__spec__', None) is not None and __main__.__spec__.parent:
        # === BEGIN OF BACKPORT
        spec = __main__.__spec__
        if (spec.name == '__main__' or spec.name.endswith('.__main__')) and spec.parent:
            name = spec.parent
        else:
            name = spec.name
        args += ['-m', name]
        # === END OF BACKPORT ===

        args += sys.argv[1:]
    elif not py_script.exists():
        # sys.argv[0] may not exist for several reasons on Windows.
        # It may exist with a .exe extension or have a -script.py suffix.
        exe_entrypoint = py_script.with_suffix('.exe')
        if exe_entrypoint.exists():
            # Should be executed directly, ignoring sys.executable.
            # TODO: Remove str() when dropping support for PY37.
            # args parameter accepts path-like on Windows from Python 3.8.
            return [str(exe_entrypoint), *sys.argv[1:]]
        script_entrypoint = py_script.with_name('%s-script.py' % py_script.name)
        if script_entrypoint.exists():
            # Should be executed as usual.
            # TODO: Remove str() when dropping support for PY37.
            # args parameter accepts path-like on Windows from Python 3.8.
            return [*args, str(script_entrypoint), *sys.argv[1:]]
        raise RuntimeError('Script %s does not exist.' % py_script)
    else:
        args += sys.argv
    return args


# TODO(dmu) MEDIUM: Upgrade to Django version (probably v4.x) that includes
#                   https://github.com/django/django/commit/9e4780dedac15adcc04309d0198f4ae34e04cc2a
#                   and remove the backport and monkey patching
#                   See: https://code.djangoproject.com/ticket/32669
autoreload.get_child_arguments = get_child_arguments


def main():
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'node.config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            'available on your PYTHONPATH environment variable? Did you '
            'forget to activate a virtual environment?'
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
